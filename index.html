<html>
<head>
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
  <style>
    #mapid {width:500px;height:400px;float:left;}
    #properties {width:600px;float:left;}
  </style>
  <script src="js/jquery-1.12.0.min.js"></script>
  <script src="js/underscore-min.js"></script>
  <script src="js/leaflet.v0.7.7.js"></script>
  <script src="js/d3.min.js"></script>
  <title>Data View Experiment</title>
</head>
<body>
  <div id="mapid"></div>
  <div id="properties">  </div>
  <script type="text/javascript">
  var metadataCodes = ["B01001", "B01002", "B08301", "B11001", "B19051"];
  var polygons, c_albu, mymap;
  
  c_albu = [35.113, -106.621]
  mymap = L.map('mapid').setView(c_albu, 13);
  
  L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibGNhbXBvYmFzc28iLCJhIjoiY2ltYXFmbjVvMDAyNndibTh4ZHNqc2wwNyJ9.syOjNgJD6dNn76vuuRaobQ', {
    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
    maxZoom: 18,
    id: 'mapbox.streets'
  }).addTo(mymap);
  
  //var marker = L.marker(c_albu).addTo(mymap);
  //marker.bindPopup("<b>Hello world!</b><br>I am a popup.").openPopup();
  //console.log(polygons);
  var geojsonMarkerOptions = {
    radius: 3,
    fillColor: "#ff7800",
    color: "#f00",
    weight: 1,
    opacity: 1,
    fillOpacity: 0.8
  };
  
  
  function getColor(d) {
    return 
      d > 1000 ? '#800026' :
      d > 500  ? '#BD0026' :
      d > 200  ? '#E31A1C' :
      d > 100  ? '#FC4E2A' :
      d > 50   ? '#FD8D3C' :
      d > 20   ? '#FEB24C' :
      d > 10   ? '#FED976' :
                 '#FFEDA0';
  }
  
  var tweetslatLons = [];
  csvToArray("Twitter_141103.csv",function(data){
    tweetslatLons = _.map(data, function(x){
      return [parseFloat(x[x.length-3]),parseFloat(x[x.length-2])]
    });
    //_.each(tweetslatLons, function(cd){L.circleMarker(cd, geojsonMarkerOptions).addTo(mymap)});
  });
  
  var descriptions = {};
  _.each(metadataCodes,function(code){
    csvToArray("ACS_13_5YR_" + code + "_metadata.csv",function(data){
      descriptions[code] = data;
    }, true);
  });
  
  // ######## EVENTS #########  
  addMapping(function(a){
    a.on('click', function(e) {
      var fileCode, propName;
      var props = _.pairs(e.layer.feature.properties);
      // var id = props[12];
      var realProps = _.map(_.rest(props, 14), function(x) {
        fileCode = (x[0].split("_"))[3];
        propName = _.rest(x[0].split("_"),6).join("_");
        return [descriptions[fileCode][propName],x[1]];   
      });
      console.log(realProps);
      var groups = _.groupBy(realProps, function(p){ return strContains(p[0], "Estimate;")});
      function removePrefix(x){return [(x[0].split("; "))[1], x[1]];}
      var estimates = _.map(groups["true"],removePrefix);
      var errors = _.map(groups["false"],removePrefix);
      /*var propsToHtml = function (props){
        return _.map(realProps, function(p){return p[0] + ': ' + p[1] +'; </br>';}).join("");
      };*/
      var propsToHtml = function (props){
        return _.map(estimates, function(p){return p[0] + ' ' + p[1] +' </br>';}).join("");
      };
      var prev, el, voice, o, cat, datum;
      var coll = {totals:{}};
      console.log("estimates", estimates);
      _.each(estimates, function(x){
        el = x[0].split("-");
        datum = parseInt(x[1]);
        if(el.length>1) {
          voice = (el[1]).trim();
          cat = (el[0]).trim();
          //console.log("el, voice, x, prev", el, voice, x, prev, coll[prev], coll);
          if(prev==undefined){
            o = {};
            o[voice] = datum;
            coll[cat] = o; 
            //console.log("prev==undefined", coll, prev);       
          } else if(prev != cat) {
            o = {};
            o[voice] = datum;
            coll[cat] = o;
            //console.log("prev != cat", coll, prev, cat);           
          } else {        
            //console.log("else", coll, coll, prev);
            coll[prev][voice] = datum;    
          }      
          prev = cat;
          
        } else {
          el = x[0].split(" ");
          coll["totals"][el[0].replace(':','')] = datum;
        }
      });
      console.log(coll);
      
      $('#properties')
        .html(propsToHtml());
    });
  });  
  
  // ######## UTILS ##########
  function strContains(x, str) {
    return (x.indexOf(str) !== -1);
  }
  function addMapping(callbackFunction) {
    $.getJSON("BernallioCensusBlocks_Joined.json", function(json) {
     /* _.each(json.features, function(feat){
        var polygonBounds = L.polygon(feat.geometry.coordinates[0]).addTo(mymap).getBounds();
        polygonBounds.contains([parseFloat(latLons[0][0]),parseFloat(latLons[0][1])]);
      });*/
      var numericCircle = function(rad){
        return {
          radius: rad,
          fillColor: "#ff7800",
          color: "#f00",
          weight: 1,
          opacity: 1,
          fillOpacity: 0.8
        };  
      };
      var geoLayer = L.geoJson(json,{
        onEachFeature: function(feature, layer) {
          var polygonBounds = L.polygon(feature.geometry.coordinates[0]).getBounds();
          var howMany = _.filter(_.map(tweetslatLons, function(cd){
            return polygonBounds.contains([cd[1], cd[0]]);
          }), function(x){return x;}).length;
          var cnt = polygonBounds.getCenter();
          L.circleMarker([cnt.lng, cnt.lat], numericCircle(howMany/5)).addTo(mymap);
        },
        style: {
          "color": "#0077ff",
          "weight": 3,
          "opacity": 0.65
        }
      }).addTo(mymap);
      callbackFunction(geoLayer);      
    });
  }
  
  function csvToArray(fileInput, callbackFunction,asObject = false) {
    // ref: http://stackoverflow.com/questions/7431268/how-to-read-data-from-csv-file-using-javascript
    // modified with _.js
    var processData = function(allText) {
      var allTextLines = allText.split(/\r\n|\n/);
      if(asObject){
        var s; 
        var objList = {};
        _.each(allTextLines, function(line){
          if(line.length>0) {
            s = line.split(',');
            objList[s[0]] = s[1];
          }
        });      
        return objList;
      } else 
        return _.map(allTextLines,function(line){
          return line.split(',');
        });
    }
    
    $(document).ready(function() {
      $.ajax({
          type: "GET",
          url: fileInput,
          dataType: "text",
          success: function(data){ callbackFunction(processData(data));}
      });
    });
  }

  </script>
</body>
</html>